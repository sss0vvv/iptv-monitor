name: Monitor IPTV File

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥æäº¤æ–‡ä»¶
  actions: read

jobs:
  check_update:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: åˆ›å»ºé€šçŸ¥è„šæœ¬
        run: |
          cat > send_notify.js << 'EOF'
          const axios = require('axios');
          const nodemailer = require('nodemailer');

          async function sendNotify(title, content) {
          
            let success = false;

            // å¾®ä¿¡é€šçŸ¥
            if (process.env.SERVERCHAN_KEY) {
              try {
                const res = await axios.get(`https://sctapi.ftqq.com/${process.env.SERVERCHAN_KEY}.send`, {
                  params: { title, desp: content }
                });
                console.log('å¾®ä¿¡é€šçŸ¥å‘é€æˆåŠŸ:');
                success = true;
              } catch (err) {
                console.error('å¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥:', err.response?.data || err.message);
              }
            } else {
              console.log('æœªè®¾ç½® SERVERCHAN_KEYï¼Œè·³è¿‡å¾®ä¿¡é€šçŸ¥');
            }

            // é‚®ä»¶é€šçŸ¥
            if (process.env.EMAIL_USER && process.env.EMAIL_PASS && process.env.EMAIL_TO) {
              const transporter = nodemailer.createTransport({
                host: 'smtp.163.com',
                port: 465,
                secure: true,
                auth: {
                  user: process.env.EMAIL_USER,
                  pass: process.env.EMAIL_PASS
                }
              });

              try {
                const info = await transporter.sendMail({
                  from: `"IPTV Monitor" <${process.env.EMAIL_USER}>`,
                  to: process.env.EMAIL_TO,
                  subject: title,
                  text: content
                });
                console.log('é‚®ä»¶å‘é€æˆåŠŸ:');
                success = true;
              } catch (err) {
                console.error('é‚®ä»¶å‘é€å¤±è´¥:', err.message);
              }
            } else {
              console.log('é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡é‚®ä»¶é€šçŸ¥');
            }

            return success;
          }

          if (require.main === module) {
            const title = process.argv[2] || 'æµ‹è¯•æ ‡é¢˜';
            const content = process.argv[3] || 'æµ‹è¯•å†…å®¹';
            sendNotify(title, content).catch(console.error);
          }

          module.exports = sendNotify;
          EOF

      - name: å®‰è£…ä¾èµ–
        run: |
          npm init -y
          npm install axios nodemailer

      - name: æ£€æŸ¥æ–‡ä»¶æ›´æ–°
        id: check_update
        env:
          SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "æ­£åœ¨è·å–æœ€æ–°çš„ SHA..."
          SHA=$(curl -s -H "User-Agent: UpdateChecker" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/mursor1985/LIVE/commits?path=iptv.m3u" | \
            jq -r '.[0].sha')
          
          if [ "$SHA" = "null" ] || [ -z "$SHA" ]; then
            echo "âŒ è·å– SHA å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… è·å–åˆ°æœ€æ–° SHA: $SHA"

          # ä»ä»“åº“è¯»å–ä¸Šæ¬¡çš„ SHA
          LAST_SHA=""
          echo "æ­£åœ¨è¯»å–ä¸Šæ¬¡ä¿å­˜çš„ SHA..."
          if git show HEAD:.last_sha.txt 2>/dev/null; then
            LAST_SHA=$(git show HEAD:.last_sha.txt 2>/dev/null || echo "")
            echo "ğŸ“– è¯»å–åˆ°ä¸Šæ¬¡çš„ SHA: $LAST_SHA"
          else
            echo "ğŸ“ é¦–æ¬¡è¿è¡Œï¼Œæ²¡æœ‰å†å²è®°å½•"
          fi

          if [ "$SHA" != "$LAST_SHA" ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ–°ï¼"
            echo "  æ—§ SHA: $LAST_SHA"
            echo "  æ–° SHA: $SHA"
            
            COMMIT_INFO=$(curl -s -H "User-Agent: UpdateChecker" \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/mursor1985/LIVE/commits/$SHA" | \
              jq -r '.commit.message' | head -1)
            
            COMMIT_DATE=$(curl -s -H "User-Agent: UpdateChecker" \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/mursor1985/LIVE/commits/$SHA" | \
              jq -r '.commit.committer.date')
            
            echo "ğŸ“¤ å‘é€æ›´æ–°é€šçŸ¥..."
            node send_notify.js \
              "ğŸ”” IPTV æ–‡ä»¶å·²æ›´æ–°" \
              "ğŸ“º iptv.m3u æ–‡ä»¶æœ‰æ–°çš„æ›´æ–°

          ğŸ†” æœ€æ–°æäº¤: $SHA
          ğŸ’¬ æäº¤ä¿¡æ¯: $COMMIT_INFO  
          â° æäº¤æ—¶é—´: $COMMIT_DATE

          ğŸ”— æŸ¥çœ‹æ–‡ä»¶: https://github.com/mursor1985/LIVE/blob/main/iptv.m3u
          ğŸ”— æŸ¥çœ‹æäº¤: https://github.com/mursor1985/LIVE/commit/$SHA"
            
            # ä¿å­˜æ–°çš„ SHA åˆ°ä»“åº“æ–‡ä»¶
            echo "ğŸ’¾ ä¿å­˜æ–°çš„ SHA åˆ°ä»“åº“..."
            echo "$SHA" > .last_sha.txt
            
            # é…ç½® git
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # æäº¤æ›´æ–°
            git add .last_sha.txt
            if git diff --cached --quiet; then
              echo "âš ï¸ æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
            else
              git commit -m "Update IPTV SHA to $SHA"
              git push
              echo "âœ… SHA å·²ä¿å­˜åˆ°ä»“åº“"
            fi
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "new_sha=$SHA" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡é€šçŸ¥"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: æ˜¾ç¤ºè¿è¡Œç»“æœ
        run: |
          echo "ğŸ“Š æœ¬æ¬¡è¿è¡Œç»“æœ:"
          echo "  æ›´æ–°çŠ¶æ€: ${{ steps.check_update.outputs.updated }}"
          if [ "${{ steps.check_update.outputs.updated }}" = "true" ]; then
            echo "  æ–° SHA: ${{ steps.check_update.outputs.new_sha }}"
          fi
